name: "Setup FortiClient VPN"
description: "Installs FortiClient VPN and configures a VPN profile"
runs:
  using: "composite"
  steps:
    - name: Install Dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y expect ca-certificates

    - name: Download and Install FortiClient VPN
      shell: bash
      run: |
        wget https://links.fortinet.com/forticlient/deb/vpnagent -O forticlient.deb
        sudo dpkg -i forticlient.deb || echo "First installation attempt failed"

        sudo apt install -y libayatana-appindicator1 libnss3-tools || {
          sudo apt --fix-broken install -y && sudo dpkg --configure -a && sudo apt install -f -y || {
            echo "Dependency installation failed"
          }
        }

        sudo dpkg -i forticlient.deb || { echo "Final installation failed"; exit 1; }

    - name: Verify Installation
      shell: bash
      run: dpkg -l | grep forticlient || echo "FortiClient installation check failed!"

    - name: Create VPN Profile
      shell: bash
      run: |
        cat <<EOF > create_vpn_profile.exp
        #!/usr/bin/expect -f
        spawn /opt/forticlient/fortivpn edit myvpn
        expect -re "Type" { send -- "1\r" }
        expect -re "Remote Gateway:" { send -- "${VPN_HOST}\r" }
        expect -re "Port" { send -- "${VPN_PORT}\r" }
        expect -re "Authentication" { send -- "3\r" }
        expect -re "Certificate" { send -- "3\r" }
        expect eof
        EOF

        chmod +x create_vpn_profile.exp
        ./create_vpn_profile.exp && rm -f create_vpn_profile.exp
