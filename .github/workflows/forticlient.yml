name: FortiClient VPN Setup and Manage

on:
  workflow_dispatch:
    
jobs:
  forticlient-setup:
    runs-on: ubuntu-22.04

    steps:
    
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y expect ca-certificates
      
      - name: Download and Install FortiClient VPN
        run: |
          wget https://links.fortinet.com/forticlient/deb/vpnagent -O forticlient.deb
          sudo dpkg -i forticlient.deb || echo "First installation attempt failed"
          
          sudo apt install -y libayatana-appindicator1 libnss3-tools || {
            sudo apt --fix-broken install -y && sudo dpkg --configure -a && sudo apt install -f -y || {
              echo "Dependency installation failed"
            }
          }
          
          sudo dpkg -i forticlient.deb || { echo "Final installation failed"; exit 1; }
      
      - name: Verify Installation
        run: dpkg -l | grep forticlient || echo "FortiClient installation check failed!"
      
      - name: Create VPN Profile
        run: |
          cat <<EOF > create_vpn_profile.exp
          #!/usr/bin/expect -f
          spawn /opt/forticlient/fortivpn edit myvpn
          expect -re "Type" { send -- "1\r" }
          expect -re "Remote Gateway:" { send -- "${{ secrets.VPN_HOST }}\r" }
          expect -re "Port" { send -- "${{ secrets.VPN_PORT }}\r" }
          expect -re "Authentication" { send -- "3\r" }
          expect -re "Certificate" { send -- "3\r" }
          expect eof
          EOF
          
          chmod +x create_vpn_profile.exp
          ./create_vpn_profile.exp && rm -f create_vpn_profile.exp

      - name: Set up tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          
      # - name: List VPN Script
      #   run: |
      #    /opt/forticlient/fortivpn list
      #    /opt/forticlient/fortivpn view myvpn
      #    FORTITOKEN_SECRET=${{ secrets.FORTICLIENT_TOKEN }}
      #    TOKEN=$(oathtool --totp -b "$FORTITOKEN_SECRET")
      #    echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      # - name: Create VPN Connect Script
      #   run: |
      #     echo '#!/usr/bin/expect -f' > vpnconnect.exp
      #     echo 'spawn /opt/forticlient/fortivpn connect myvpn --user=${{ secrets.VPN_USER }} --password' >> vpnconnect.exp
      #     echo 'expect -exact "password:"' >> vpnconnect.exp
      #     echo 'send -- "${{ secrets.VPN_PASS }}\r"' >> vpnconnect.exp 
      #     #echo 'set timeout -1' >> vpnconnect.exp
      #     echo 'expect -re "Confirm "' >> vpnconnect.exp
      #     echo 'send -- "y\r"' >> vpnconnect.exp
      #     #echo 'set timeout -1' >> vpnconnect.exp
      #     echo 'expect -exact "fortiToken:"' >> vpnconnect.exp
      #     echo 'send -- "${{ env.OTP }}\r"' >> vpnconnect.exp
      #     echo 'expect eof' >> vpnconnect.exp
      #     chmod +x vpnconnect.exp
      #     ./vpnconnect.exp

      - name: VPN Status
        run: |
          /opt/forticlient/fortivpn status

      # - name: Clean Up
      #   run: |
      #     rm ./vpnconnect.exp
